---
title: 使用Rust编写阅览ELF文件的命令
tags:
---



## 关于ELF文件

在Linux上，源文件可以被编译成一个可重定位文件，可重定位文件包含了汇编代码和全局数据，多个可重定位文件可以被链接并合并为一个新的可重定位文件，也可以被链接为共享目标文件或可执行文件，其中可重定位文件、共享目标文件和可执行文件都是ELF文件

对于可重定位文件、共享目标文件和可执行文件较详细说明：

> - **可重定位目标**文件包含代码节和数据节。此文件适合与其他可重定位目标文件链接，从而创建动态可执行文件、共享目标文件或其他可重定位目标文件。
> - **动态可执行**文件包含可随时执行的程序。此文件指定了 [`exec`(2)](http://www.oracle.com/pls/topic/lookup?ctx=E26505&id=REFMAN2exec-2) 创建程序的进程映像的方式。此文件通常在运行时绑定到共享目标文件以创建进程映像。
> - **共享目标文件**文件包含适用于进行其他链接的代码和数据。链接编辑器可将此文件与其他可重定位目标文件和共享目标文件一起处理，以创建其他目标文件。运行时链接程序会将此文件与动态可执行文件和其他共享目标文件合并，以创建进程映像。
>
> 程序可以使用 ELF 访问库 `libelf` 所提供的函数来处理目标文件。有关 `libelf` 内容的说明，请参阅 [`elf`(3ELF)](http://www.oracle.com/pls/topic/lookup?ctx=E26505&id=REFMAN3Eelf-3elf)。`/usr/demo/ELF` 目录下的 `SUNWosdem` 软件包中提供了使用 `libelf` 的源代码样例。

## 关于ELF文件格式

先整体看一下ELF文件的格式：

![](https://docs.oracle.com/cd/E38902_01/html/E38861/figures/ObjFileFmt.png)

程序的编译过程一般是`预编译-编译-汇编-链接-执行`，其中汇编、链接和执行过程操作的文件都是ELF文件。上面图片展示了ELF文件的两种视图，分别是链接过程的ELF数据分布和执行过程的ELF数据分布。

- **ELF头：**ELF文件中只有ELF头是固定位置，通过ELF头提供的信息可以获取程序头表、节头表的位置信息，
- **程序头表：**指示系统如何创建进程映像。用于生成进程映像、可执行文件和共享目标文件的文件必须具有程序头表。可重定位目标文件无需程序头表
- **节：**ELF文件里存在多个节，每个节保存不同类型的信息，例如包含指令、数据、符号表和重定位信息。
- **段：**段是节的集合，是在运行时被链接程序映射到内存映像的最小独立单元。
- **节头表：**节头表列出了每个节的名称、大小和位置等信息。链接编辑过程中使用的文件必须具有节头表。

> **注 -** 只有 ELF 头在文件中具有固定位置。由于 ELF 格式的灵活性，不要求头表、节或段具有指定的顺序

## 关于ELF文件所有数据的类型

为了方便移植，ELF文件规定了所有数据结构都遵循相关类的自然大小和对齐规则。主要分为32位和64位两种，这保证了无论在什么计算机上ELF文件都可以参考通用标识来解释。

**表 12-1 ELF 32 位数据类型**

| 名称            | 大小 | 对齐 | 目的           |
| --------------- | ---- | ---- | -------------- |
| `Elf32_Addr`    | `4`  | `4`  | 无符号程序地址 |
| `Elf32_Half`    | `2`  | `2`  | 无符号中整数   |
| `Elf32_Off`     | `4`  | `4`  | 无符号文件偏移 |
| `Elf32_Sword`   | `4`  | `4`  | 带符号整数     |
| `Elf32_Word`    | `4`  | `4`  | 无符号整数     |
| `unsigned char` | `1`  | `1`  | 无符号小整数   |



**表 12-2 ELF 64 位数据类型**

| 名称            | 大小 | 对齐 | 目的           |
| --------------- | ---- | ---- | -------------- |
| `Elf64_Addr`    | `8`  | `8`  | 无符号程序地址 |
| `Elf64_Half`    | `2`  | `2`  | 无符号中整数   |
| `Elf64_Off`     | `8`  | `8`  | 无符号文件偏移 |
| `Elf64_Sword`   | `4`  | `4`  | 带符号整数     |
| `Elf64_Word`    | `4`  | `4`  | 无符号整数     |
| `Elf64_Xword`   | `8`  | `8`  | 无符号长整数   |
| `Elf64_Sxword`  | `8`  | `8`  | 带符合长整数   |
| `unsigned char` | `1`  | `1`  | 无符号小整数   |



参考文章：

[链接程序和库指南](https://docs.oracle.com/cd/E38902_01/html/E38861/chapter6-93046.html#scrolltoc)
